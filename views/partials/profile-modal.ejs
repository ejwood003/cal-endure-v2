<!-- Profile Modal -->
<div id="profileModal" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: #faf0ca; margin: 2% auto; padding: 0; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div class="modal-header" style="background: #0d3b66; color: white; padding: 20px 30px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 24px;">Profile Settings</h2>
            <span class="close-modal" onclick="closeProfileModal()" style="cursor: pointer; font-size: 32px; font-weight: bold; line-height: 1;">&times;</span>
        </div>
        <div class="modal-body" style="padding: 30px;">
            <!-- Tabs -->
            <div class="profile-tabs" style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #0d3b66;">
                <button class="tab-btn active" onclick="switchProfileTab('info')" data-tab="info" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid #0d3b66; color: #0d3b66; font-weight: 600; cursor: pointer; font-size: 16px;">Profile Info</button>
                <button class="tab-btn" onclick="switchProfileTab('photo')" data-tab="photo" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: #697268; font-weight: 600; cursor: pointer; font-size: 16px;">Photo</button>
                <button class="tab-btn" onclick="switchProfileTab('password')" data-tab="password" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: #697268; font-weight: 600; cursor: pointer; font-size: 16px;">Password</button>
                <button class="tab-btn" onclick="switchProfileTab('danger')" data-tab="danger" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: #990000; font-weight: 600; cursor: pointer; font-size: 16px;">Delete Account</button>
            </div>

            <!-- Profile Info Tab -->
            <div id="tab-info" class="tab-content" style="display: block;">
                <form action="/profile/update" method="POST" style="max-width: 600px;">
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="modal-firstName" style="display: block; margin-bottom: 8px; color: #0d3b66; font-weight: 500;">First Name</label>
                            <input type="text" id="modal-firstName" name="firstName" value="<%= user.first_name %>" required class="form-control" style="width: 100%; padding: 10px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label for="modal-lastName" style="display: block; margin-bottom: 8px; color: #0d3b66; font-weight: 500;">Last Name</label>
                            <input type="text" id="modal-lastName" name="lastName" value="<%= user.last_name %>" required class="form-control" style="width: 100%; padding: 10px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 14px;">
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="modal-email" style="display: block; margin-bottom: 8px; color: #0d3b66; font-weight: 500;">Email Address</label>
                        <input type="email" id="modal-email" name="email" value="<%= user.email %>" required class="form-control" style="width: 100%; padding: 10px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 14px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="modal-username" style="display: block; margin-bottom: 8px; color: #0d3b66; font-weight: 500;">Username</label>
                        <input type="text" id="modal-username" name="username" value="<%= user.username %>" required class="form-control" style="width: 100%; padding: 10px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 14px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="modal-mission" style="display: block; margin-bottom: 8px; color: #0d3b66; font-weight: 500;">Mission (Optional)</label>
                        <input type="text" id="modal-mission" name="mission" value="<%= user.mission || '' %>" placeholder="e.g., California San Diego Mission" class="form-control" style="width: 100%; padding: 10px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 14px;">
                    </div>

                    <button type="submit" class="btn-primary" style="background: #0d3b66; color: white; padding: 12px 32px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600;">Update Profile</button>
                </form>
            </div>

            <!-- Photo Tab -->
            <div id="tab-photo" class="tab-content" style="display: none;">
                <div style="display: flex; align-items: center; gap: 30px; margin-bottom: 30px;">
                    <img src="<%= user.profile_photo || 'https://via.placeholder.com/120' %>" alt="Profile Photo" id="currentProfilePhoto" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #0d3b66;">
                    <div>
                        <h3 style="color: #0d3b66; margin-bottom: 10px;">Current Photo</h3>
                        <p style="color: #697268; margin-bottom: 15px;">Upload a new photo to update your profile picture</p>
                    </div>
                </div>
                <form action="/profile/photo" method="POST" enctype="multipart/form-data" style="max-width: 600px;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="modal-profilePhoto" style="display: block; margin-bottom: 10px; color: #0d3b66; font-weight: 500;">Choose new photo:</label>
                        <input type="file" id="modal-profilePhoto" name="profilePhoto" accept="image/*" required style="display: block; margin-bottom: 15px;">
                        <small style="color: #697268; display: block; margin-bottom: 15px;">Max file size: 5MB. Accepted formats: JPG, PNG, GIF</small>
                    </div>
                    <button type="submit" class="btn-primary" style="background: #0d3b66; color: white; padding: 12px 32px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600;">Upload Photo</button>
                </form>
            </div>

            <!-- Password Tab -->
            <div id="tab-password" class="tab-content" style="display: none;">
                <form action="/profile/password" method="POST" onsubmit="return validatePasswordChange()" style="max-width: 600px;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="modal-currentPassword" style="display: block; margin-bottom: 8px; color: #0d3b66; font-weight: 500;">Current Password</label>
                        <input type="password" id="modal-currentPassword" name="currentPassword" required minlength="6" class="form-control" style="width: 100%; padding: 10px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 14px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="modal-newPassword" style="display: block; margin-bottom: 8px; color: #0d3b66; font-weight: 500;">New Password</label>
                        <input type="password" id="modal-newPassword" name="newPassword" required minlength="6" class="form-control" style="width: 100%; padding: 10px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 14px;">
                        <small style="color: #697268; display: block; margin-top: 5px;">Minimum 6 characters</small>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="modal-confirmPassword" style="display: block; margin-bottom: 8px; color: #0d3b66; font-weight: 500;">Confirm New Password</label>
                        <input type="password" id="modal-confirmPassword" name="confirmPassword" required minlength="6" class="form-control" style="width: 100%; padding: 10px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 14px;">
                    </div>

                    <button type="submit" class="btn-primary" style="background: #0d3b66; color: white; padding: 12px 32px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600;">Change Password</button>
                </form>
            </div>

            <!-- Danger Zone Tab -->
            <div id="tab-danger" class="tab-content" style="display: none;">
                <div style="background: #fee; border: 2px solid #fcc; border-radius: 8px; padding: 25px; max-width: 600px;">
                    <h3 style="color: #990000; margin-bottom: 15px;">Delete Account</h3>
                    <p style="color: #c00; margin-bottom: 20px; line-height: 1.6;">
                        <strong>Warning:</strong> This action cannot be undone. This will permanently delete your account,
                        including all your goals, events, and contacts.
                    </p>
                    <button onclick="confirmDeleteAccount()" class="btn-danger" style="background: #990000; color: white; padding: 12px 32px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600;">
                        Delete My Account
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function openProfileModal() {
        document.getElementById('profileModal').style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closeProfileModal() {
        document.getElementById('profileModal').style.display = 'none';
        document.body.style.overflow = 'auto'; // Restore scrolling
    }

    function switchProfileTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.style.display = 'none';
        });

        // Remove active class from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.style.borderBottomColor = 'transparent';
            btn.style.color = btn.dataset.tab === 'danger' ? '#990000' : '#697268';
        });

        // Show selected tab
        document.getElementById('tab-' + tabName).style.display = 'block';

        // Add active class to clicked button
        const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
        activeBtn.style.borderBottomColor = tabName === 'danger' ? '#990000' : '#0d3b66';
        activeBtn.style.color = tabName === 'danger' ? '#990000' : '#0d3b66';
    }

    function validatePasswordChange() {
        const newPassword = document.getElementById('modal-newPassword').value;
        const confirmPassword = document.getElementById('modal-confirmPassword').value;

        if (newPassword !== confirmPassword) {
            alert('New passwords do not match!');
            return false;
        }

        if (newPassword.length < 6) {
            alert('Password must be at least 6 characters long!');
            return false;
        }

        return true;
    }

    function confirmDeleteAccount() {
        if (confirm('Are you absolutely sure you want to delete your account? This action cannot be undone.')) {
            if (confirm('This will permanently delete all your goals, events, and contacts. Continue?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/profile/delete';
                document.body.appendChild(form);
                form.submit();
            }
        }
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
        const modal = document.getElementById('profileModal');
        if (event.target == modal) {
            closeProfileModal();
        }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeProfileModal();
        }
    });
</script>
