<%- include('partials/header', {pageTitle: 'Calendar - Cal-Endure to the End'}) %>
<body class="app-page">
    <%- include('partials/app-navbar', {currentPage: 'calendar'}) %>

    <!-- Main Content -->
    <main class="app-main calendar-app">
        <div class="calendar-wrapper">
            <!-- Calendar Section -->
            <div class="calendar-section">
                <!-- Page Header -->
                <header class="page-header">
                    <div>
                        <h1 class="page-title">Calendar</h1>
                        <p class="page-subtitle">Plan every hour of your day</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn-secondary" onclick="goToToday()">Today</button>
                        <button class="btn-primary" onclick="openAddEventPanel()">+ Add Event</button>
                    </div>
                </header>

                <!-- Calendar Controls -->
                <div class="calendar-controls">
                    <div class="calendar-nav">
                        <button class="btn-icon" onclick="navigatePrevious()">‚óÄ</button>
                        <h2 id="current-period"></h2>
                        <button class="btn-icon" onclick="navigateNext()">‚ñ∂</button>
                    </div>
                    <div class="calendar-view-toggle">
                        <button class="view-btn" data-view="month" onclick="switchView('month')">Month</button>
                        <button class="view-btn active" data-view="week" onclick="switchView('week')">Week</button>
                        <button class="view-btn" data-view="day" onclick="switchView('day')">Day</button>
                    </div>
                </div>

                <!-- Month View -->
                <div id="month-view" class="calendar-view" style="display: none;">
                    <div class="calendar-weekdays">
                        <div class="weekday">Sun</div>
                        <div class="weekday">Mon</div>
                        <div class="weekday">Tue</div>
                        <div class="weekday">Wed</div>
                        <div class="weekday">Thu</div>
                        <div class="weekday">Fri</div>
                        <div class="weekday">Sat</div>
                    </div>
                    <div class="calendar-month-grid" id="month-grid">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- Week View -->
                <div id="week-view" class="calendar-view" style="display: block;">
                    <div class="calendar-week-header">
                        <div class="time-gutter">Time</div>
                        <div class="week-days-header" id="week-days-header">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                    <div class="calendar-week-body">
                        <div class="time-column" id="time-column">
                            <!-- 24 hours, 30-min increments = 48 slots -->
                        </div>
                        <div class="week-days-grid" id="week-days-grid">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Day View -->
                <div id="day-view" class="calendar-view" style="display: none;">
                    <div class="calendar-day-header">
                        <div class="time-gutter">Time</div>
                        <div class="day-header" id="day-header">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                    <div class="calendar-day-body">
                        <div class="time-column" id="day-time-column">
                            <!-- 24 hours, 30-min increments -->
                        </div>
                        <div class="day-column" id="day-column">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Event Side Panel -->
            <div id="event-panel" class="event-panel">
                <div class="panel-header">
                    <h2 id="panel-title">Event Details</h2>
                    <button class="panel-close" onclick="closeEventPanel()">&times;</button>
                </div>
                <div class="panel-content">
                    <form id="event-form" onsubmit="saveEvent(event)">
                        <input type="hidden" id="event-id" name="eventId">
                        <input type="hidden" id="event-mode" value="create">

                        <div class="form-group">
                            <label for="event-title">Title *</label>
                            <input type="text" id="event-title" name="title" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="event-date">Date *</label>
                                <input type="date" id="event-date" name="eventDate" required>
                            </div>
                            <div class="form-group">
                                <label for="event-color">Color</label>
                                <input type="color" id="event-color" name="color" value="#0d3b66">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="event-start-time">Start Time *</label>
                                <input type="time" id="event-start-time" name="startTime" required>
                            </div>
                            <div class="form-group">
                                <label for="event-end-time">End Time</label>
                                <input type="time" id="event-end-time" name="endTime">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="event-type">Type</label>
                            <select id="event-type" name="eventType">
                                <option value="Spiritual">‚úùÔ∏è Spiritual</option>
                                <option value="Social">üë• Social</option>
                                <option value="Intellectual">üìö Intellectual</option>
                                <option value="Physical">üí™ Physical</option>
                                <option value="Romantic">‚ù§Ô∏è Romantic</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="event-location">Location</label>
                            <input type="text" id="event-location" name="location">
                        </div>

                        <div class="form-group">
                            <label for="event-notes">Notes</label>
                            <textarea id="event-notes" name="notes" rows="3"></textarea>
                        </div>

                        <% if (typeof contacts !== 'undefined' && contacts.length > 0) { %>
                        <div class="form-group">
                            <label for="event-contacts">Contacts (optional)</label>
                            <select id="event-contacts" name="contacts" multiple>
                                <% contacts.forEach(function(contact) { %>
                                    <option value="<%= contact.contact_id %>">
                                        <%= contact.first_name %> <%= contact.last_name %>
                                    </option>
                                <% }); %>
                            </select>
                        </div>
                        <% } %>

                        <% if (typeof goals !== 'undefined') { %>
                        <div class="form-group">
                            <label for="event-goal">Link to Goal (optional)</label>
                            <select id="event-goal" name="goalId">
                                <option value="">None</option>
                                <% if (goals && goals.length > 0) { %>
                                    <% goals.filter(g => g.goal_type === 'calendar').forEach(function(goal) { %>
                                        <option value="<%= goal.goal_id %>"><%= goal.title %></option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>
                        <% } %>

                        <div class="form-group">
                            <label for="event-status">Status</label>
                            <select id="event-status" name="status">
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                                <option value="missed">Missed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>

                        <div class="panel-actions">
                            <button type="button" class="btn-outline" onclick="closeEventPanel()">Cancel</button>
                            <button type="button" id="delete-btn" class="btn-danger" onclick="deleteEvent()" style="display: none;">Delete</button>
                            <button type="submit" class="btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        // State
        let currentView = 'week';
        let currentDate = new Date();
        let events = <%- JSON.stringify(events || []) %>;
        let draggedEvent = null;
        let draggedEventOriginal = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            goToToday();
            renderCurrentView();
        });

        // View Switching
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            document.querySelectorAll('.calendar-view').forEach(v => {
                v.style.display = 'none';
            });
            document.getElementById(view + '-view').style.display = 'block';
            renderCurrentView();
        }

        // Navigation
        function navigatePrevious() {
            if (currentView === 'month') {
                currentDate.setMonth(currentDate.getMonth() - 1);
            } else if (currentView === 'week') {
                currentDate.setDate(currentDate.getDate() - 7);
            } else {
                currentDate.setDate(currentDate.getDate() - 1);
            }
            renderCurrentView();
        }

        function navigateNext() {
            if (currentView === 'month') {
                currentDate.setMonth(currentDate.getMonth() + 1);
            } else if (currentView === 'week') {
                currentDate.setDate(currentDate.getDate() + 7);
            } else {
                currentDate.setDate(currentDate.getDate() + 1);
            }
            renderCurrentView();
        }

        function goToToday() {
            currentDate = new Date();
            renderCurrentView();
        }

        // Render Current View
        function renderCurrentView() {
            if (currentView === 'month') {
                renderMonthView();
            } else if (currentView === 'week') {
                renderWeekView();
            } else {
                renderDayView();
            }
            updatePeriodLabel();
        }

        function updatePeriodLabel() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];

            if (currentView === 'month') {
                document.getElementById('current-period').textContent =
                    `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            } else if (currentView === 'week') {
                const weekStart = getWeekStart(currentDate);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                document.getElementById('current-period').textContent =
                    `${monthNames[weekStart.getMonth()]} ${weekStart.getDate()} - ${monthNames[weekEnd.getMonth()]} ${weekEnd.getDate()}, ${weekEnd.getFullYear()}`;
            } else {
                document.getElementById('current-period').textContent =
                    `${monthNames[currentDate.getMonth()]} ${currentDate.getDate()}, ${currentDate.getFullYear()}`;
            }
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        // MONTH VIEW
        function renderMonthView() {
            const grid = document.getElementById('month-grid');
            grid.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            for (let i = 0; i < 42; i++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(dayDate.getDate() + i);

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                if (dayDate.getMonth() !== month) {
                    dayDiv.classList.add('other-month');
                }
                if (isToday(dayDate)) {
                    dayDiv.classList.add('today');
                }

                dayDiv.dataset.date = formatDate(dayDate);
                dayDiv.ondragover = (e) => e.preventDefault();
                dayDiv.ondrop = (e) => handleMonthDrop(e, dayDate);

                dayDiv.innerHTML = `
                    <div class="day-number">${dayDate.getDate()}</div>
                    <div class="day-events" id="events-${formatDate(dayDate)}">
                        ${renderMonthEvents(dayDate)}
                    </div>
                `;

                grid.appendChild(dayDiv);
            }
        }

        function renderMonthEvents(date) {
            const dateStr = formatDate(date);
            const dayEvents = events.filter(e => e.event_date === dateStr);

            return dayEvents.map(event => `
                <div class="month-event"
                     draggable="true"
                     ondragstart="startDragEvent(event, ${event.event_id})"
                     onclick="openEventPanel(${event.event_id})"
                     style="background-color: ${event.color || '#0d3b66'};">
                    ${event.start_time ? event.start_time.substring(0, 5) : ''} ${event.title}
                </div>
            `).join('');
        }

        // WEEK VIEW
        function renderWeekView() {
            renderTimeColumn('time-column');

            const weekStart = getWeekStart(currentDate);
            const header = document.getElementById('week-days-header');
            const grid = document.getElementById('week-days-grid');

            header.innerHTML = '';
            grid.innerHTML = '';

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(dayDate.getDate() + i);

                // Header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'day-header-cell';
                if (isToday(dayDate)) headerDiv.classList.add('today');
                headerDiv.innerHTML = `
                    <div class="day-name">${days[i]}</div>
                    <div class="day-number">${dayDate.getDate()}</div>
                `;
                header.appendChild(headerDiv);

                // Day column with time slots
                const dayCol = document.createElement('div');
                dayCol.className = 'day-column';
                dayCol.dataset.date = formatDate(dayDate);

                // Create 48 half-hour slots
                for (let hour = 0; hour < 24; hour++) {
                    for (let half = 0; half < 2; half++) {
                        const slotDiv = document.createElement('div');
                        slotDiv.className = 'time-slot';
                        slotDiv.dataset.time = `${String(hour).padStart(2, '0')}:${half === 0 ? '00' : '30'}`;
                        slotDiv.onclick = () => createEventAtSlot(dayDate, slotDiv.dataset.time);
                        slotDiv.ondragover = (e) => e.preventDefault();
                        slotDiv.ondrop = (e) => handleWeekDrop(e, dayDate, slotDiv.dataset.time);
                        dayCol.appendChild(slotDiv);
                    }
                }

                // Render events for this day
                renderWeekDayEvents(dayCol, dayDate);

                grid.appendChild(dayCol);
            }
        }

        function renderWeekDayEvents(dayCol, date) {
            const dateStr = formatDate(date);
            const dayEvents = events.filter(e => e.event_date === dateStr);

            dayEvents.forEach(event => {
                const eventDiv = createEventElement(event, 'week');
                dayCol.appendChild(eventDiv);
            });
        }

        // DAY VIEW
        function renderDayView() {
            renderTimeColumn('day-time-column');

            const header = document.getElementById('day-header');
            const column = document.getElementById('day-column');

            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            header.innerHTML = `
                <div class="day-header-cell today">
                    <div class="day-name">${days[currentDate.getDay()]}</div>
                    <div class="day-number">${currentDate.getDate()}</div>
                </div>
            `;

            column.innerHTML = '';
            column.dataset.date = formatDate(currentDate);

            // Create time slots
            for (let hour = 0; hour < 24; hour++) {
                for (let half = 0; half < 2; half++) {
                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'time-slot';
                    slotDiv.dataset.time = `${String(hour).padStart(2, '0')}:${half === 0 ? '00' : '30'}`;
                    slotDiv.onclick = () => createEventAtSlot(currentDate, slotDiv.dataset.time);
                    slotDiv.ondragover = (e) => e.preventDefault();
                    slotDiv.ondrop = (e) => handleDayDrop(e, slotDiv.dataset.time);
                    column.appendChild(slotDiv);
                }
            }

            // Render events
            const dateStr = formatDate(currentDate);
            const dayEvents = events.filter(e => e.event_date === dateStr);
            dayEvents.forEach(event => {
                const eventDiv = createEventElement(event, 'day');
                column.appendChild(eventDiv);
            });
        }

        function renderTimeColumn(id) {
            const column = document.getElementById(id);
            column.innerHTML = '';

            for (let hour = 0; hour < 24; hour++) {
                const timeDiv = document.createElement('div');
                timeDiv.className = 'time-label';
                timeDiv.textContent = `${String(hour).padStart(2, '0')}:00`;
                column.appendChild(timeDiv);

                const halfDiv = document.createElement('div');
                halfDiv.className = 'time-label half';
                column.appendChild(halfDiv);
            }
        }

        function createEventElement(event, viewType) {
            const div = document.createElement('div');
            div.className = 'calendar-event';
            div.dataset.eventId = event.event_id;
            div.draggable = true;
            div.ondragstart = (e) => startDragEvent(e, event.event_id);
            div.onclick = () => openEventPanel(event.event_id);
            div.style.backgroundColor = event.color || '#0d3b66';

            // Calculate position and height
            const startMinutes = timeToMinutes(event.start_time);
            const endMinutes = event.end_time ? timeToMinutes(event.end_time) : startMinutes + 30;
            const duration = endMinutes - startMinutes;

            // Position from top (each 30min slot = 30px)
            const top = (startMinutes / 30) * 30;
            const height = Math.max((duration / 30) * 30, 20);

            div.style.top = top + 'px';
            div.style.height = height + 'px';

            div.innerHTML = `
                <div class="event-time">${event.start_time ? event.start_time.substring(0,5) : ''}</div>
                <div class="event-title">${event.title}</div>
            `;

            return div;
        }

        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        // Drag and Drop
        function startDragEvent(e, eventId) {
            draggedEvent = events.find(ev => ev.event_id === eventId);
            draggedEventOriginal = {...draggedEvent};
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleMonthDrop(e, newDate) {
            e.preventDefault();
            if (!draggedEvent) return;

            // Keep same time, change date
            const newDateStr = formatDate(newDate);
            updateEventDate(draggedEvent.event_id, newDateStr);
        }

        function handleWeekDrop(e, newDate, newTime) {
            e.preventDefault();
            if (!draggedEvent) return;

            // Change both date and time
            const newDateStr = formatDate(newDate);
            updateEventDateTime(draggedEvent.event_id, newDateStr, newTime);
        }

        function handleDayDrop(e, newTime) {
            e.preventDefault();
            if (!draggedEvent) return;

            // Keep same date, change time
            updateEventTime(draggedEvent.event_id, newTime);
        }

        async function updateEventDate(eventId, newDate) {
            try {
                const response = await fetch(`/calendar/move/${eventId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({newDate})
                });
                if (response.ok) {
                    const event = events.find(e => e.event_id === eventId);
                    event.event_date = newDate;
                    renderCurrentView();
                }
            } catch (error) {
                console.error('Error moving event:', error);
            }
        }

        async function updateEventDateTime(eventId, newDate, newTime) {
            try {
                // Calculate end time based on original duration
                const event = events.find(e => e.event_id === eventId);
                let endTime = null;
                if (event.start_time && event.end_time) {
                    const startMins = timeToMinutes(event.start_time);
                    const endMins = timeToMinutes(event.end_time);
                    const duration = endMins - startMins;
                    const newStartMins = timeToMinutes(newTime);
                    const newEndMins = newStartMins + duration;
                    const hours = Math.floor(newEndMins / 60);
                    const mins = newEndMins % 60;
                    endTime = `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
                }

                const response = await fetch(`/calendar/update/${eventId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: new URLSearchParams({
                        title: event.title,
                        eventDate: newDate,
                        startTime: newTime,
                        endTime: endTime || newTime,
                        eventType: event.event_type || 'Spiritual',
                        location: event.location || '',
                        notes: event.notes || ''
                    })
                });

                if (response.ok) {
                    event.event_date = newDate;
                    event.start_time = newTime;
                    event.end_time = endTime;
                    renderCurrentView();
                }
            } catch (error) {
                console.error('Error updating event:', error);
            }
        }

        async function updateEventTime(eventId, newTime) {
            const event = events.find(e => e.event_id === eventId);
            await updateEventDateTime(eventId, event.event_date, newTime);
        }

        // Event Panel
        function openAddEventPanel() {
            document.getElementById('event-mode').value = 'create';
            document.getElementById('panel-title').textContent = 'Add New Event';
            document.getElementById('event-form').reset();
            document.getElementById('event-date').value = formatDate(currentDate);
            document.getElementById('delete-btn').style.display = 'none';
            document.getElementById('event-panel').classList.add('open');
        }

        function createEventAtSlot(date, time) {
            openAddEventPanel();
            document.getElementById('event-date').value = formatDate(date);
            document.getElementById('event-start-time').value = time;
        }

        function openEventPanel(eventId) {
            const event = events.find(e => e.event_id === eventId);
            if (!event) return;

            document.getElementById('event-mode').value = 'edit';
            document.getElementById('event-id').value = event.event_id;
            document.getElementById('panel-title').textContent = 'Edit Event';
            document.getElementById('event-title').value = event.title || '';
            document.getElementById('event-date').value = event.event_date || '';
            document.getElementById('event-start-time').value = event.start_time || '';
            document.getElementById('event-end-time').value = event.end_time || '';
            document.getElementById('event-type').value = event.event_type || 'Spiritual';
            document.getElementById('event-location').value = event.location || '';
            document.getElementById('event-notes').value = event.notes || '';
            document.getElementById('event-color').value = event.color || '#0d3b66';
            document.getElementById('event-status').value = event.status || 'pending';
            document.getElementById('delete-btn').style.display = 'block';
            document.getElementById('event-panel').classList.add('open');
        }

        function closeEventPanel() {
            document.getElementById('event-panel').classList.remove('open');
        }

        async function saveEvent(e) {
            e.preventDefault();
            const form = document.getElementById('event-form');
            const mode = document.getElementById('event-mode').value;
            const eventId = document.getElementById('event-id').value;

            const url = mode === 'create' ? '/calendar/create' : `/calendar/update/${eventId}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: new URLSearchParams(new FormData(form))
                });

                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error saving event');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving event');
            }
        }

        async function deleteEvent() {
            if (!confirm('Delete this event?')) return;

            const eventId = document.getElementById('event-id').value;

            try {
                const response = await fetch(`/calendar/delete/${eventId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error deleting event');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting event');
            }
        }
    </script>

    <%- include('partials/profile-modal') %>
</body>
</html>
