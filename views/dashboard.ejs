<%- include('partials/header', {pageTitle: 'Goals Dashboard - Cal-Endure to the End'}) %>
<body class="app-page">
    <%- include('partials/app-navbar', {currentPage: 'dashboard'}) %>

    <!-- Main Content -->
    <main class="app-main">
        <div class="app-container">
            <!-- Page Header -->
            <header class="page-header">
                <div>
                    <h1 class="page-title">Your Goals</h1>
                    <p class="page-subtitle">Track numeric goals, recurring habits, and calendar-based achievements</p>
                </div>
                <div class="header-actions">
                    <button class="btn-primary" onclick="openAddGoalModal()">
                        <span>+ Add Goal</span>
                    </button>
                </div>
            </header>

            <!-- Goals Overview Stats -->
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-info">
                        <div class="stat-value"><%= stats.total %></div>
                        <div class="stat-label">Total Goals</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-info">
                        <div class="stat-value"><%= stats.completed %></div>
                        <div class="stat-label">Completed</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-info">
                        <div class="stat-value"><%= stats.active %></div>
                        <div class="stat-label">In Progress</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-info">
                        <div class="stat-value"><%= stats.eventstoday %></div>
                        <div class="stat-label">Events Today</div>
                    </div>
                </div>
            </div>

            <!-- Goals Categories Grid -->
            <div class="goals-grid">
                <% ['Spiritual', 'Social', 'Intellectual', 'Physical', 'Romantic'].forEach(function(categoryName) {
                    const categoryIcons = {
                        'Spiritual': '‚úùÔ∏è',
                        'Social': 'üë•',
                        'Intellectual': 'üìö',
                        'Physical': 'üí™',
                        'Romantic': '‚ù§Ô∏è'
                    };
                    const categoryClass = categoryName.toLowerCase();
                    const categoryGoals = goalsByCategory[categoryName] || [];
                    const categoryProgress = progress[categoryClass] || 0;
                %>
                <!-- <%= categoryName %> Goals -->
                <div class="goal-category <%= categoryClass %>">
                    <div class="category-header">
                        <div class="category-title-row">
                            <div class="category-icon"><%= categoryIcons[categoryName] %></div>
                            <h2 class="category-title"><%= categoryName %></h2>
                        </div>
                        <button class="btn-add-goal" onclick="addGoalToCategory('<%= categoryClass %>')">
                            <span class="add-icon">+</span>
                            <span class="add-text">Add Goal</span>
                        </button>
                    </div>
                    <div class="category-progress-section">
                        <div class="progress-bar-container">
                            <div class="progress-bar">
                                <div class="progress-fill <%= categoryClass %>-fill" style="width: <%= categoryProgress %>%"></div>
                            </div>
                        </div>
                        <span class="progress-label"><%= categoryProgress %>% Complete</span>
                    </div>
                    <div class="goals-list">
                        <% if (categoryGoals.length > 0) { %>
                            <% categoryGoals.forEach(function(goal) { %>
                                <!-- Goal card based on type -->
                                <% if (goal.goal_type === 'numeric') { %>
                                    <!-- NUMERIC GOAL -->
                                    <div class="goal-card numeric-goal <%= goal.is_completed ? 'completed' : '' %>" data-goal-id="<%= goal.goal_id %>">
                                        <div class="goal-card-header">
                                            <div class="goal-type-badge numeric-badge">
                                                <span class="badge-icon">üìä</span>
                                                <span class="badge-text">Numeric</span>
                                            </div>
                                            <form action="/goals/delete/<%= goal.goal_id %>" method="POST" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this goal?')">
                                                <button type="submit" class="btn-delete" title="Delete goal">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                                    </svg>
                                                </button>
                                            </form>
                                        </div>
                                        <div class="goal-card-body">
                                            <h3 class="goal-card-title"><%= goal.title %></h3>
                                            <% if (goal.description) { %>
                                                <p class="goal-card-description"><%= goal.description %></p>
                                            <% } %>
                                            <div class="numeric-progress-section">
                                                <div class="numeric-stats-large">
                                                    <span class="current-value"><%= goal.numeric_current_value || 0 %></span>
                                                    <span class="separator">/</span>
                                                    <span class="target-value"><%= goal.numeric_target_value %></span>
                                                    <span class="unit"><%= goal.numeric_unit || 'times' %></span>
                                                </div>
                                                <div class="progress-bar-modern">
                                                    <div class="progress-fill-modern" style="width: <%= Math.min(100, (goal.numeric_current_value / goal.numeric_target_value) * 100) %>%"></div>
                                                </div>
                                                <div class="progress-percentage">
                                                    <%= Math.round(Math.min(100, (goal.numeric_current_value / goal.numeric_target_value) * 100)) %>% Complete
                                                </div>
                                            </div>
                                        </div>
                                        <div class="goal-card-actions">
                                            <button class="btn-action-primary" onclick="incrementNumericGoal(<%= goal.goal_id %>)">
                                                <span class="action-icon">+</span>
                                                <span class="action-text">Add Progress</span>
                                            </button>
                                        </div>
                                    </div>
                                <% } else if (goal.goal_type === 'recurring') { %>
                                    <!-- RECURRING GOAL -->
                                    <%
                                    const pattern = goal.recurrence_pattern || 'daily';
                                    const interval = goal.recurrence_interval || 1;
                                    let patternText = '';
                                    if (interval === 1) {
                                        patternText = pattern.charAt(0).toUpperCase() + pattern.slice(1);
                                    } else {
                                        patternText = `Every ${interval} ${pattern === 'daily' ? 'days' : pattern === 'weekly' ? 'weeks' : 'months'}`;
                                    }
                                    const lastCompleted = goal.last_completed_at ? new Date(goal.last_completed_at) : null;
                                    const now = new Date();
                                    let canComplete = true;
                                    if (lastCompleted) {
                                        if (goal.recurrence_pattern === 'daily') {
                                            canComplete = lastCompleted.toDateString() !== now.toDateString();
                                        } else if (goal.recurrence_pattern === 'weekly') {
                                            const daysDiff = Math.floor((now - lastCompleted) / (1000 * 60 * 60 * 24));
                                            canComplete = daysDiff >= 7;
                                        } else if (goal.recurrence_pattern === 'monthly') {
                                            canComplete = lastCompleted.getMonth() !== now.getMonth() || lastCompleted.getFullYear() !== now.getFullYear();
                                        }
                                    }
                                    %>
                                    <div class="goal-card recurring-goal <%= goal.is_completed ? 'completed' : '' %>" data-goal-id="<%= goal.goal_id %>">
                                        <div class="goal-card-header">
                                            <div class="goal-type-badge recurring-badge">
                                                <span class="badge-icon">üîÑ</span>
                                                <span class="badge-text">Recurring</span>
                                            </div>
                                            <form action="/goals/delete/<%= goal.goal_id %>" method="POST" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this goal?')">
                                                <button type="submit" class="btn-delete" title="Delete goal">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                                    </svg>
                                                </button>
                                            </form>
                                        </div>
                                        <div class="goal-card-body">
                                            <h3 class="goal-card-title"><%= goal.title %></h3>
                                            <% if (goal.description) { %>
                                                <p class="goal-card-description"><%= goal.description %></p>
                                            <% } %>
                                            <div class="recurring-info-section">
                                                <div class="recurrence-pattern-display">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10"/>
                                                        <polyline points="12 6 12 12 16 14"/>
                                                    </svg>
                                                    <span class="pattern-text"><%= patternText %></span>
                                                </div>
                                                <div class="completion-stats">
                                                    <span class="streak-count">üî• <%= goal.completion_count || 0 %> completions</span>
                                                    <% if (lastCompleted) { %>
                                                        <span class="last-completed">Last: <%= lastCompleted.toLocaleDateString() %></span>
                                                    <% } %>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="goal-card-actions">
                                            <button class="btn-action-<%= canComplete ? 'success' : 'disabled' %>"
                                                    onclick="completeRecurringGoal(<%= goal.goal_id %>)"
                                                    <%= canComplete ? '' : 'disabled' %>>
                                                <span class="action-icon">‚úì</span>
                                                <span class="action-text"><%= canComplete ? 'Mark Complete' : 'Already Completed' %></span>
                                            </button>
                                        </div>
                                    </div>
                                <% } else if (goal.goal_type === 'calendar') { %>
                                    <!-- CALENDAR GOAL -->
                                    <%
                                    const completed = goal.completed_events || 0;
                                    const required = goal.linked_events_required || 0;
                                    const percentage = required > 0 ? Math.min(100, (completed / required) * 100) : 0;
                                    %>
                                    <div class="goal-card calendar-goal <%= goal.is_completed ? 'completed' : '' %>" data-goal-id="<%= goal.goal_id %>">
                                        <div class="goal-card-header">
                                            <div class="goal-type-badge calendar-badge">
                                                <span class="badge-icon">üìÖ</span>
                                                <span class="badge-text">Calendar</span>
                                            </div>
                                            <form action="/goals/delete/<%= goal.goal_id %>" method="POST" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this goal?')">
                                                <button type="submit" class="btn-delete" title="Delete goal">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                                    </svg>
                                                </button>
                                            </form>
                                        </div>
                                        <div class="goal-card-body">
                                            <h3 class="goal-card-title"><%= goal.title %></h3>
                                            <% if (goal.description) { %>
                                                <p class="goal-card-description"><%= goal.description %></p>
                                            <% } %>
                                            <% if (goal.target_date) { %>
                                                <div class="target-date-display">
                                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                                    </svg>
                                                    <span>Target: <%= new Date(goal.target_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></span>
                                                </div>
                                            <% } %>
                                            <div class="calendar-progress-section">
                                                <div class="calendar-stats-large">
                                                    <span class="completed-events"><%= completed %></span>
                                                    <span class="separator">/</span>
                                                    <span class="required-events"><%= required %></span>
                                                    <span class="events-label">events</span>
                                                </div>
                                                <div class="progress-bar-modern">
                                                    <div class="progress-fill-modern" style="width: <%= percentage %>%"></div>
                                                </div>
                                                <div class="progress-percentage">
                                                    <%= Math.round(percentage) %>% Complete
                                                </div>
                                            </div>
                                        </div>
                                        <div class="goal-card-actions">
                                            <a href="/calendar?goal=<%= goal.goal_id %>" class="btn-action-outline">
                                                <span class="action-icon">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                                    </svg>
                                                </span>
                                                <span class="action-text">View in Calendar</span>
                                            </a>
                                        </div>
                                    </div>
                                <% } %>
                            <% }); %>
                        <% } else { %>
                            <div class="empty-state-card">
                                <div class="empty-state-icon">üìù</div>
                                <p class="empty-state-text">No <%= categoryClass %> goals yet</p>
                                <button class="btn-empty-state" onclick="addGoalToCategory('<%= categoryClass %>')">
                                    <span>+ Create your first <%= categoryClass %> goal</span>
                                </button>
                            </div>
                        <% } %>
                    </div>
                </div>
                <% }); %>
            </div>
        </div>
    </main>

    <!-- Add/Edit Goal Modal -->
    <div id="goal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Goal</h2>
                <button class="modal-close" onclick="closeGoalModal()">&times;</button>
            </div>
            <form id="goal-form" class="modal-form" action="/goals/create" method="POST">
                <!-- Goal Type Selection -->
                <div class="form-group">
                    <label for="goal-type-select">Goal Type *</label>
                    <select id="goal-type-select" name="goalType" required onchange="updateGoalFormFields()">
                        <option value="">Select goal type...</option>
                        <option value="numeric">üìä Numeric - Track a number (e.g., read 10 books)</option>
                        <option value="recurring">üîÑ Recurring - Repeat regularly (e.g., exercise daily)</option>
                        <option value="calendar">üìÖ Calendar - Complete events by a date</option>
                    </select>
                </div>

                <!-- Category Selection -->
                <div class="form-group">
                    <label for="goal-category-select">Category *</label>
                    <select id="goal-category-select" name="category" required>
                        <option value="">Select category...</option>
                        <option value="Spiritual">‚úùÔ∏è Spiritual</option>
                        <option value="Social">üë• Social</option>
                        <option value="Intellectual">üìö Intellectual</option>
                        <option value="Physical">üí™ Physical</option>
                        <option value="Romantic">‚ù§Ô∏è Romantic</option>
                    </select>
                </div>

                <!-- Common Fields -->
                <div class="form-group">
                    <label for="goal-title">Goal Title *</label>
                    <input type="text" id="goal-title" name="title" placeholder="What do you want to achieve?" required>
                </div>
                <div class="form-group">
                    <label for="goal-description">Description (Optional)</label>
                    <textarea id="goal-description" name="description" rows="3" placeholder="Add more details..."></textarea>
                </div>

                <!-- Numeric Goal Fields -->
                <div id="numeric-fields" class="type-specific-fields" style="display: none;">
                    <div class="form-group">
                        <label for="numeric-target">Target Value *</label>
                        <input type="number" id="numeric-target" name="numericTarget" placeholder="e.g., 30" min="1">
                    </div>
                    <div class="form-group">
                        <label for="numeric-unit">Unit *</label>
                        <input type="text" id="numeric-unit" name="numericUnit" placeholder="e.g., books, pages, times" value="times">
                    </div>
                </div>

                <!-- Recurring Goal Fields -->
                <div id="recurring-fields" class="type-specific-fields" style="display: none;">
                    <div class="form-group">
                        <label for="recurrence-pattern">Frequency *</label>
                        <select id="recurrence-pattern" name="recurrencePattern">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="recurrence-interval">Repeat Every *</label>
                        <input type="number" id="recurrence-interval" name="recurrenceInterval" value="1" min="1" max="30">
                        <small>e.g., "2" for every 2 days/weeks/months</small>
                    </div>
                </div>

                <!-- Calendar Goal Fields -->
                <div id="calendar-fields" class="type-specific-fields" style="display: none;">
                    <div class="form-group">
                        <label for="target-date">Target Date *</label>
                        <input type="date" id="target-date" name="targetDate">
                    </div>
                    <div class="form-group">
                        <label for="events-required">Required Events *</label>
                        <input type="number" id="events-required" name="eventsRequired" placeholder="How many events to complete?" min="1">
                        <small>You'll link events to this goal from the Calendar page</small>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-outline" onclick="closeGoalModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Create Goal</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Modal functions
        function openAddGoalModal(category = '') {
            document.getElementById('goal-modal').style.display = 'flex';
            document.getElementById('modal-title').textContent = 'Add New Goal';
            document.getElementById('goal-form').reset();
            if (category) {
                const capitalizedCategory = category.charAt(0).toUpperCase() + category.slice(1);
                document.getElementById('goal-category-select').value = capitalizedCategory;
            }
            updateGoalFormFields(); // Reset form fields
        }

        function addGoalToCategory(category) {
            openAddGoalModal(category);
        }

        function closeGoalModal() {
            document.getElementById('goal-modal').style.display = 'none';
        }

        // Update form fields based on goal type
        function updateGoalFormFields() {
            const goalType = document.getElementById('goal-type-select').value;

            // Hide all type-specific fields
            document.querySelectorAll('.type-specific-fields').forEach(el => {
                el.style.display = 'none';
                // Remove required from hidden fields
                el.querySelectorAll('input, select').forEach(input => {
                    input.removeAttribute('required');
                });
            });

            // Show and require fields for selected type
            if (goalType === 'numeric') {
                const numericFields = document.getElementById('numeric-fields');
                numericFields.style.display = 'block';
                document.getElementById('numeric-target').setAttribute('required', 'required');
                document.getElementById('numeric-unit').setAttribute('required', 'required');
            } else if (goalType === 'recurring') {
                const recurringFields = document.getElementById('recurring-fields');
                recurringFields.style.display = 'block';
                document.getElementById('recurrence-pattern').setAttribute('required', 'required');
                document.getElementById('recurrence-interval').setAttribute('required', 'required');
            } else if (goalType === 'calendar') {
                const calendarFields = document.getElementById('calendar-fields');
                calendarFields.style.display = 'block';
                document.getElementById('target-date').setAttribute('required', 'required');
                document.getElementById('events-required').setAttribute('required', 'required');
            }
        }

        // Increment numeric goal
        async function incrementNumericGoal(goalId) {
            try {
                const response = await fetch(`/goals/numeric/${goalId}/log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: 1 })
                });

                const data = await response.json();
                if (data.success) {
                    // Update UI
                    const goalCard = document.querySelector(`[data-goal-id="${goalId}"]`);
                    const currentValue = goalCard.querySelector('.current-value');
                    if (currentValue) {
                        currentValue.textContent = data.current;
                    }

                    // Update progress bar
                    const progressFill = goalCard.querySelector('.progress-fill');
                    if (progressFill) {
                        const percentage = Math.min(100, (data.current / data.target) * 100);
                        progressFill.style.width = percentage + '%';
                    }

                    // Mark as completed if done
                    if (data.completed) {
                        goalCard.classList.add('completed');
                        setTimeout(() => location.reload(), 1000);
                    }
                } else {
                    alert('Error updating goal: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to update goal');
            }
        }

        // Complete recurring goal
        async function completeRecurringGoal(goalId) {
            try {
                const response = await fetch(`/goals/recurring/${goalId}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                if (data.success) {
                    // Reload to show updated completion status
                    location.reload();
                } else {
                    alert(data.error || 'Error completing goal');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to complete goal');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('goal-modal');
            if (event.target === modal) {
                closeGoalModal();
            }
        }
    </script>

    <%- include('partials/profile-modal') %>
</body>
</html>
